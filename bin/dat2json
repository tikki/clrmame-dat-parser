#!/usr/bin/env python

"""Convert a CLRMame Pro .dat file to JSON.
"""

import sys
import json

from clrmame.dat import parse
import clrmame.structs


def _usage():
    """Print usage and quit."""
    print(f"""
Usage: {sys.argv[0]} filename

    filename   the name of the .dat file (clrmame format), or '-'.

If filename is '-', input will be read from STDIN.
""")
    sys.exit(1)


def jsonify(thing):
    if hasattr(thing, '_json_') and callable(thing._json_):
        return thing._json_()
    return thing


def main(args):
    """main"""
    if len(args) != 1:
        _usage()
    filename = args[0]
    fileobj = sys.stdin if filename == '-' else open(filename, 'r')
    out = sys.stdout.write
    out("[")
    first = True
    typemap = {getattr(clrmame.structs, name): name.lower()
               for name in clrmame.structs.__all__}
    for entry in parse(fileobj):
        if not first:
            out(","),
        first = False
        etype = type(entry)
        out(json.dumps(entry if etype not in typemap
                       else {typemap[etype]: entry}, default=jsonify))
    out("]")

if __name__ == '__main__':
    main(sys.argv[1:])
